<link rel="import" href="../bower_components/px-map/px-map.html">
<link rel="import" href="../bower_components/px-map/px-map-tile-layer.html">
<link rel="import" href="../bower_components/px-map/px-map-tile-layer-bing.html">
<link rel="import" href="../bower_components/px-map/px-map-layer-geojson.html">
<link rel="import" href="../bower_components/px-map/px-map-control-zoom.html">
<link rel="import" href="../bower_components/px-map/px-map-marker-static.html">
<link rel="import" href="../bower_components/px-map/px-map-marker-symbol.html">
<link rel="import" href="../bower_components/px-map/px-map-popup-info.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/px-modal/px-modal.html"/>
<link rel="import" href="../bower_components/px-vis-xy-chart/px-vis-xy-chart.html"/>

<dom-module id="my-view5">
        <template>
            <style>
                px-map {
                    width: 100%;
                    height: 50vh;
                }
                px-viz-xy-chart {
                   width: 100%;
                   height: 45vh;
                }


            </style>

            <div id="ajax">

            </div>


            <px-map id="worldMap" zoom="15" lat="53.289274411765973" lng="-6.253227258892083" flex-to-size="true" max-zoom="21">
                <px-map-tile-layer url='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'></px-map-tile-layer>
                <px-map-control-zoom position="bottomright"></px-map-control-zoom>

            </px-map>

            <px-vis-xy-chart debounce-resize-timing="250" width="507.046875" height="300" progressive-rendering-points-per-frame="16000" progressive-rendering-min-frames="1" chart-horizontal-alignment="center" chart-vertical-alignment="center" margin='{"top":30,"bottom":60,"left":75,"right":20}' tooltip-config='{"forceDateTimeDisplay":true}' register-config='{"type":"vertical","width":220,"forceDateTimeDisplay":true}' selection-type="xy" chart-data='[{"Date":1468213850000,"T48A":1332,"T48B":1346,"T48C":1330,"T48D":1342,"Line":1340},{"Date":1468213968000,"T48A":1336,"T48B":1343,"T48C":1336,"T48D":1340,"Line":1343},{"Date":1468214133000,"T48A":1341,"T48B":1345,"T48C":1331,"T48D":1333,"Line":1345},{"Date":1468214253000,"T48A":1348,"T48B":1344,"T48C":1343,"T48D":1339,"Line":1350},{"Date":1468214374000,"T48A":1352,"T48B":1346,"T48C":1335,"T48D":1342,"Line":1357},{"Date":1468214564000,"T48A":1341,"T48B":1342,"T48C":1344,"T48D":1346},{"Date":1468214682000,"T48A":1348,"T48B":1353,"T48C":1337,"T48D":1331},{"Date":1468214852000,"T48A":1346,"T48B":1348,"T48C":1339,"T48D":1335},{"Date":1468231470000,"T48A":1353,"T48B":1355},{"Date":1468231590000,"T48A":1359,"T48B":1359},{"Date":1468232041000,"T48A":1357,"T48B":1359},{"Date":1468232184000,"T48A":1357,"T48B":1359},{"Date":1468232301000,"T48A":1353,"T48B":1359},{"Date":1468232417000,"T48A":1353,"T48B":1357},{"Date":1468232576000,"T48A":1353,"T48B":1355},{"Date":1468232693000,"T48A":1355,"T48B":1360},{"Date":1468232845000,"T48A":1355,"T48B":1355},{"Date":1468232966000,"T48A":1353,"T48B":1359},{"Date":1468233083000,"T48A":1355,"T48B":1357}]' series-config='{"secondSerie":{"type":"line","name":"Load Forecast","x":"T48A","y":"Line","axis":{"id":"axis2","number":2,"side":"left"}}}' chart-extents='{"x":["dynamic","dynamic"],"y":["dynamic","dynamic"]}' event-data='[{"id":"123","label":"Fa Icon","x":"1334"},{"id":"456","label":"Unicode","x":"1342"},{"id":"789","label":"Default","x":"1346"}]' event-config='{"Fa Icon":{"color":"blue","icon":"fa-camera","type":"fa","offset":[0,0]},"Unicode":{"color":"green","icon":"ï€•","type":"unicode","offset":[1,0]},"Event Png":{"icon":"ge_logo.png","type":"image","offset":[0,-20],"size":"20"}}' x-axis-config='{"title":"Time","labelPosition":"center","orientation":"bottom"}' y-axis-config='{"title":"Kw","labelPosition":"center","orientation":"left"}' time-data="Date" dynamic-menu-config='[{"name":"Delete","action":"function(data) {var conf = this.seriesConfig;delete conf[data.additionalDetail.name];this.set(\"seriesConfig\", {}); this.set(\"seriesConfig\", conf);","eventName":"delete","icon":"fa-trash"},{"name":"Bring To Front","action":"function(data) {this.set(\"serieToRedrawOnTop\", data.additionalDetail.name);}","eventName":"bring-to-front","icon":"fa-arrow-up"}]' toolbar-config='{"config":{"advancedZoom":true,"pan":true,"tooltip":true,"logHover":{"buttonGroup":2,"tooltipLabel":"The submenu item of this menu will define custom mouse interaction","icon":"fa-leaf","subConfig":{"customClick":{"icon":"fa-coffee","buttonGroup":3,"tooltipLabel":"define some custom mouse interactions on chart","eventName":"my-custom-click","actionConfig":{"mousedown":"function(mousePos) { console.log(\"custom click on chart. Context is the chart. Mouse pos is available: \" + JSON.stringify(mousePos))}","mouseup":"function(mousePos) { console.log(\"custom action on mouse up the chart \" + JSON.stringify(mousePos));}","mouseout":"function(mousePos) { console.log(\"custom action on mouse out the chart \" + JSON.stringify(mousePos));}","mousemove":"function(mousePos) { console.log(\"custom action on hovering the chart \");}"}},"customClick2":{"buttonGroup":3,"icon":"fa-fire-extinguisher","tooltipLabel":"Remove all custom interactions","actionConfig":{"mousedown":null,"mouseup":null,"mouseout":null,"mousemove":null}}}}}}' nav-height="100" nav-margin='{"top":5,"right":10,"bottom":20,"left":10}' nav-series-config='{"T48A":{"type":"line","name":"Trend","x":"Date","y":"T48A"}}'>
            </px-vis-xy-chart>

        </template>

        <script>



          Polymer({
            is: 'my-view5',
            properties: {
              styles: {
                type: Object,
                value: {
                  'LV_Three_Phase_Overhead_Line': {
                    color: '#0000ff'
                  },
                  "LV_Single_Phase_Overhead_Line": {
                    color: '#0000ff',
                    weight: 2
                  },
                  "LV_Overhead_Asset": {
                    color: '#0000ff',
                    weight: 2
                  },
                  "LV_Underground_Cable": {
                    color: '#ff0000'
                  },
                  "LV_Underground_Ground_Mounted_Asset": {
                    color: '#ff0000'
                  },

                  "MV_Underground_Cable": {
                    color: '#ff0000'
                  },
                  "MV_Underground_Ground_Mounted_Asset": {
                    color: '#ff0000'
                  }
                }
              }
            },

            getMapData: function() {
              var collections = Object.keys(this.styles);
              //var parent = Polymer.dom(this).querySelector('#ajax');
              var parent = this.$.ajax;
              console.log ("PARENT NEXT");
              console.log (parent);

              var ajaxCaller;
              for (var i = 0; i < collections.length; i++) {
                ajaxCaller = document.createElement('iron-ajax');
                ajaxCaller.url = 'https://mmeurope-ui-intelligent-mapping-team29.run.aws-usw02-pr.ice.predix.io/api/v1/collections/' + collections[i];
                //ajaxCaller.url = '/api/v1/collections/' + collections[i];
                ajaxCaller.id = collections[i];
                ajaxCaller.method = 'GET';
                this.listen(ajaxCaller, 'response', 'addLayer');
                this.listen(ajaxCaller, 'error', 'reportError');
                console.log (ajaxCaller);
                parent.appendChild(ajaxCaller);
                ajaxCaller.generateRequest();
              }
            },
            getStationData: function() {
              var parent = this.$.ajax;
              console.log ("PARENT NEXT");
              console.log (parent);

              var ajaxCaller;
              ajaxCaller = document.createElement('iron-ajax');
              ajaxCaller.url = 'https://mmeurope-ui-intelligent-mapping-team29.run.aws-usw02-pr.ice.predix.io/api/v1/collections/stations';
              //ajaxCaller.url = '/api/v1/collections/' + collections[i];
              ajaxCaller.id = 'stations';
              ajaxCaller.method = 'GET';
              this.listen(ajaxCaller, 'response', 'generateMapMarkers');
              this.listen(ajaxCaller, 'error', 'reportError');
              console.log (ajaxCaller);
              parent.appendChild(ajaxCaller);
              ajaxCaller.generateRequest();
            },

            attached: function() {
              this.getMapData();
              this.getStationData();
              this.getBookingData();
            },

            getBookingData: function() {
              var parent = this.$.ajax;
              var ajaxCaller;
              ajaxCaller = document.createElement('iron-ajax');
              ajaxCaller.url = 'https://hackathon-booking-database.run.aws-usw02-pr.ice.predix.io/database/usage';
              //ajaxCaller.url = '/api/v1/collections/' + collections[i];
              ajaxCaller.body = '{"startDate":"2017-JUN-13 14:22:00", "endDate":"2017-JUN-13 15:01:02"}';
              //ajaxCaller.startDate = '2017-JUN-13 14:22:00';
              //ajaxCaller.endDate = '2017-JUN-13 15:55:00';
              ajaxCaller.contentType = 'application/json';
              ajaxCaller.method = 'POST';
              console.log (ajaxCaller.queryString);
              this.listen(ajaxCaller, 'response', 'generateChartData');
              this.listen(ajaxCaller, 'error', 'reportError');

              parent.appendChild(ajaxCaller);
              ajaxCaller.generateRequest();
            },

            generateChartData: function(data) {
              console.log(data);

            },

            generateMapMarkers: function(data) {
              var map = this.$.worldMap;
              var response = data.detail.response;
              console.log(response);
              for (var i=0; i<response.features.length; ++i){
                var feature = response.features[i];
                  var marker = document.createElement('px-map-marker-symbol');
                  marker.lat = JSON.stringify(feature.geometry.coordinates[1]);
                  marker.lng = JSON.stringify(feature.geometry.coordinates[0]);
                  console.log(marker);
                  marker.symbolClass = 'fa fa-bolt';
                  var info = document.createElement('px-map-popup-info');
                  info.title = 'Charging Station';
                  info.description = 'FUCK THIS SHIT';
                  marker.appendChild(info);
                  map.appendChild(marker);
              }
            },
            openModal: function() {
              console.log("fired");
              this.$.bookChargeModal.modalButtonClicked();
              // Polymer.dom(document).querySelector("#bookChargeModal").modalButtonClicked();
            },

            addLayer: function(evt) {
              console.log('Adding layer ', evt.target.id);
              //var map = this.querySelector('px-map');
              var map = this.$.worldMap;
              var item = document.createElement('px-map-layer-geojson');
              ///

              //
              item.data = evt.detail.response;
              item.featureStyle = this.styles[evt.target.id];
              item.showFeatureProperties = true;
              map.appendChild(item);
            },
            reportError: function(evt) {
              console.error(evt);
            }
          });
        </script>

    </dom-module>
